<!DOCTYPE html>
<html lang="en">

<head>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>

    <title id="tab-title" >Websocket Chat</title>
</head>

<body>

    <div>
        <h1>Conversas</h1>
        <div id="chat-messages-container">
            <ul style="list-style-type: none;" id="users-joined"></ul>
        </div>

        <p>
            <input type="text" id="username-input" placeholder="Seu nome">
            <button id="join-button">join</button>
        </p>

        <input type="text" id="message-input" placeholder="Digite sua mensagem">
        <button id="send-button">Send</button>
    </div>

    <div id="chat-messages-container">
        <ul id="messages-list"></ul>
    </div>

    <script>

        var sock = new SockJS('http://localhost:8085/chatws');
        var stomp = Stomp.over(sock);

        // Elements
        var tabTitle = document.getElementById('tab-title');
        var messageField = document.getElementById('message-input');
        var usernameField = document.getElementById('username-input');
        var usersJoined = document.getElementById('users-joined');
        var messagesList = document.getElementById('messages-list');
        var sendButton = document.getElementById('send-button');
        var joinButton = document.getElementById('join-button');

        // usernameField.value = "Thiago"

        // STOMP: Conectando cliente stomp ao servidor
        stomp.connect({}, function (frame) {
            console.log('Connected: ' + frame);
            stomp.subscribe('/topic/messages', function (message) {
                let msg = JSON.parse(message.body);

                switch (msg.type) {
                    case 'JOIN':
                        tabTitle.innerText = 'Chat - ' + msg.sender;
                        usersJoined.appendChild(createJoinMessage(msg));
                        break;
                    case 'CHAT':
                        messagesList.appendChild(createMessage(msg));
                    default:
                        break;
                }


            });
        });

        joinButton.addEventListener('click', function () {
            console.log('click: sockJs: join');

            stomp.send("/chat/join", {}, JSON.stringify({
                sender: usernameField.value.trim(),
                type: 'JOIN'
            }));

        });

        sendButton.addEventListener('click', function () {
            console.log('click: sockJs: send');

            stomp.send("/chat/talk", {}, JSON.stringify({
                sender: usernameField.value.trim(),
                content: messageField.value.trim(),
                type: 'CHAT'
            }));

        });

        function createMessage(msg) {
            let li = document.createElement('li');
            li.innerHTML = '<b>' + msg.sender + '</b>: ' + msg.content;
            return li;
        }

        function createJoinMessage(msg) {
            let li = document.createElement('li');
            li.innerHTML = '<b>âœ…' + msg.sender + ' entrou...</b>: ';
            return li;
        }

    </script>

</body>
</html>